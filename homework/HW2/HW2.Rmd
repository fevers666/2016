---
title: "Homework 2: The Big Short"
output: html_document
---
#### Fred Evers, CSCI E-107


**This homework is due Friday February 26, 2016 at 5:00 PM. When complete, submit your code in the R Markdown file and the knitted HTML via GitHub.**

# Background 

This homework is motivated by circumstances surrounding the [financial crisis of 2007-2008](https://en.wikipedia.org/wiki/Financial_crisis_of_2007%E2%80%9308). We titled the homework _The Big Short_, after the book on the same topic that was also recently made into a movie.

Part of what caused the financial crisis was that the risk of certain [securities](https://en.wikipedia.org/wiki/Security_(finance)) sold by financial institutions were  underestimated. Specifically, 
the risk of mortgage-backed securities (MBS) and collateralized debt obligations (CDO), the price of which depends on homeowners making their monthly payments, was grossly underestimated. A combination of factors resulted in many more defaults than were expected. This resulted in a crash of the prices of these securities. As a consequence, banks lost so much money that they needed bailouts to avoid default.

Here we present a **very** simplified version of what happened with some of these securities. Hopefully it will help you understand how a wrong assumption about the statistical behavior of events can lead to substantial differences between what the model predicts and what actually happens. Specifically, we will see how using an independence assumption can result in misleading conclusions. Before we start with the specific application we ask you about a simple casino game.

# Problem 1

In the game of [roullete](https://en.wikipedia.org/wiki/Roulette)
you can bet on several things including black or red. On this bet, if you win, you double your earnings. How does the casino make money on this then? If you look at the [possibilities](http://www.math.uah.edu/stat/games/Roulette.png)
you realize that the chance of red or black are both slightly less than 1/2. There are two green spots, so the of landing on black (or red) is actually 18/38, or 9/19.


## Problem 1A

Let's make a quick sampling model for this simple version of roulette. You are going to bet a dollar each time you play and always bet on black. Make a box model for this process using the `sample` function. Write a function `get_outcome` that takes as an argument the number of times you play $N$ and returns your earnings $S_N$.

```{r}
##Your code here
library(ggplot2)
library(dplyr)
library(tidyr)
library(pollstR)
library(gtools)

#sampling model
wheel <- sample(rep( c("red", "black", "green"), times = c(18,18,2)),38,replace=FALSE)

get_outcome <- function(N){
  events <- sample( wheel, N, replace=TRUE) #
  x <- sum(as.numeric(events == "black"))
  S_N <- x # not 2*x . return ONLY earnings, not earnings plus cost
}

s = get_outcome(10) # this is a test
```

## Problem 1B

Use Monte Carlo simulation to study the distribution of total earnings $S_N$ for $N=10,25,100,1000$. That is, study the distribution of earnings for different number of plays. What are the distributions of these two random variables? How do the expected values and standard errors change with $N$? Then do the same thing for the average winnings $S_N/N$. What result that you learned in class predicts this?

```{r}
##Your code here
roulette_monty <- function(plays, B=10000){
earnings <- replicate( B, get_outcome(plays))
#mean(earnings/plays)
#x <- sum(as.numeric(spins == "black"))# total blacks
#tab <- table(spins)
#prop.table(tab)
}
n <- c(10,25,100,1000)
prob <- sapply(n,roulette_monty) # returns list of vectors
df <- as.data.frame(prob) # make data.frame
colnames(df) <- c("ten","twentyfive","hundred","thousand") # set names on columns

# show 6 number summary as indication of data distribution
summary(df$ten)
summary(df$twentyfive)
summary(df$hundred)
summary(df$thousand)

# simple histogram of each size
hist(df$ten)
hist(df$twentyfive)
hist(df$hundred)
hist(df$thousand)

# I would like to use ggplot to create a line chart comparing low to high earnings for each column of data using facets for diff columns. But there is only one vector of values per column. I have no co-ord PAIR to refer to, so cartesian plots aren't possible!  

#comparePlot <- ggplot(df,aes())
#comparePlot+geom_line() + facet_grid(ten ~ thousand, scales = "free")

### this plot fails

```

As the number of plays increases, the probability of losing also increases. This can be demonstrated by running a simulation of 10,000 trials using plays of 10, 25, 100 and 1000 and viewing histograms of earnings across the sample trial sizes. While the frequency distribution of all plays remains roughly normal, there is a noticable bunching in the distribution towards values in the center as the play moves into higher numbers. This indicates that there is a smaller standard deviation, which means a higher likelihood that the outcome will approach the expected value, which favors the casino.



## Problem 1C

What is the expected value of our sampling model? What is the standard deviation of our sampling model?


We are betting that the roulette spin will return a result of black. There are 38 total outcomes, of which 18 are black, 18 are red and 2 are green. The probability of a black is 18/38, or 9/19, which is 47% or 0.47 probability. The cost of each play is $1, and the mean expected return is .47 cents, for an average expected loss of .53 cents per play.
The Standard Deviation of the sampling model is approximately .16 cents.
So the theoretical Expected Value is .16 return on the dollar.
This can be observed by taking the results or any one of the Monte Carlo simulation and diving the sample sd by the number of tries (plays) used in the simulation.

```{r}
sd(df$ten)/10
sd(df$twentyfive)/25
sd(df$thousand)/1000

```


## Problem 1D

Use CLT to approximate the probability that the casino loses money when you play 25 times. Then use a Monte Carlo simulation to confirm.

The Central Limit Theorum holds that with a sample size of >= 30, the sample distribution will resemble a normal distribution, with the approximation of the normal distribution increasing as the sample size increases. With a sample size of < 30, as in our case, the results are less certain and more succeptible to error.
But for purposes of estimation, we know that the probability that the casino loses are 0.47 based on the design of the game.
With 25 bets, the player has a cost of $25. Using the simple binary formula for standard deviation given in the lecture, the expected value can be calculated using Sample size times the probability of interest. In our case, this means Expected Value = 25(.47) = 11.75. The Standard Error will be the Square Root of (the Expected value x [1-.47])
The standard error for our case will be 2.5.

```{r}
##Your code here
tries <- 25
pb <- .47
ExpV <- tries*pb
StErr <- sqrt(ExpV*(1-pb))

sim25 <- roulette_monty(25)
plot(sim25)
mean(sim25)
sd(sim25)
hist(pnorm(sim25,mean(sim25),sd(sim25)))
```



## Problem 1E

In general, what is the probability that the casino loses money as a function of $N$? Make a plot for values ranging from 25 to 1,000. Why does the casino give you free drinks if you keep playing?

```{r}
##Your code here


```

Your answer here. 

# Problem 2 

You run a bank that has a history of identifying potential homeowners that can be trusted to make payments. In fact, historically, in a given year, only 2% of your customers default. You want to use stochastic models to get an idea of what interest rates you should charge to guarantee a profit this upcoming year. 

## Problem 2A

Your bank gives out 1,000 loans this year. Create a sampling model and use the function `sample` to simulate the number of foreclosures in a year with the information that 2% of customers default. Also suppose your bank loses $120,000 on each foreclosure. Run the simulation for one year and report your loss.

```{r}
##your code here

# this is the base sampling model. good loans return 1, bad loans 0.
mortgageOutcome <- sample(rep( c(1, 0), times = c(98,2)),100,replace=FALSE)
# Here, replace is false. I assume this is correct because the number of loans is finite and we are basically counting down the loans, returning 2% default

getAnnualLosses <- function(nLoans){
annualLosses <- sample( mortgageOutcome, nLoans, replace=TRUE) # replace is true, because this is a random sample where each event is independent
  x <- sum(annualLosses == 0)# get number of bad loans
  losses <- x*120000 # return ONLY losses
}

losses <- getAnnualLosses(1000)  # this is a test
```

## Problem 2B

Note that the loss you will incur is a random variable. Use Monte Carlo simulation to estimate the distribution of this random variable. Use summaries and visualization to describe your potential losses to your board of trustees.

```{r}
##your code here

lossesMonteCarlo <- function(nLoans, B=10000){
  resultSet <- replicate( B, getAnnualLosses(nLoans))
}

lossSimulation <- lossesMonteCarlo(1000)
summary(lossSimulation)
lossSimMean <- mean(lossSimulation)
lossSimSd <- sd(lossSimulation)
lossSimDF <- as.data.frame(lossSimulation)
colnames(lossSimDF) <- c("losses") # set names
# need to create prob distribution graph
p2 <- ggplot(lossSimDF, 
            aes(x=losses)) 
p2 + geom_histogram() + stat_bin(binwidth = 50) + scale_x_log10()
```
The Monte Carlo simulation was run 10,000 times, simulating 10,000 tries where 2% of loans fail with an average loss per loan of $120,000. Under these conditions, the bank stands to lose about two and a half million dollars/yr to bad loans when issuing one thousand loans, with a mean of 2,401,812 and a standard deviation of 537,967. But since these results are ramdom variables, the SD and mean are not constant.


## Problem 2C

The 1,000 loans you gave out were for $180,000. The way your bank can give out loans and not lose money is by charging an interest rate. If you charge an interest rate of, say, 2% you would earn $3,600 for each loan that doesn't foreclose. At what percentage should you set the interest rate so that your expected profit totals $100,000. Hint: Create a sampling model with expected value 100 so that when multiplied by the 1,000 loans you get an expectation of $100,000. Corroborate your answer with a Monte Carlo simulation.

Your solution here. 
```{r}
###your code here

# Here is a function to return an interest rate based on desired profit.
# Thanks to Nicholas Franco

# this method returns variable results. With the rounding in the getInterestRate function, the results vary between .01 and .02

getInterestRate <- function(nLoans, desiredProfit){
  annualProfit <- sample( mortgageOutcome, nLoans, replace=TRUE)
  good <- sum(annualProfit==1)
  bad <- sum(annualProfit==0)
  neededInterestRate <- round((desiredProfit + (bad*120000))/(good*180000),digits=2)
  
}

rateFor100000 <- getInterestRate(1000,100000) # this is a test


# the getProfit function samples the mortgageOutcome model and returns net profit per year in dollars

getProfit <- function(nLoans, interestRate=0){
  annualProfit <- sample( mortgageOutcome, nLoans, replace=TRUE) 
  x <- sum(annualProfit == 1)# get number of good loans
  profitsWInterest = x*(180000*interestRate) # annual profit on good loans @ interestRate
  losses <- sum(annualProfit == 0) # get losses
  lossValue <- losses*12000 # calculate the value of the defaults
  net = profitsWInterest-lossValue # net will return the annual balance
}

# a few tests
profits <- getProfit(1000)# this is a test of 0 interest
profits <- getProfit(1000, .002)# this is a test

# this is a monte carlo that runs simulation and returns results in dollars
profitMonteCarlo <- function(nLoans, interestRate=0, B=10000){
  resultSet <- replicate( B, getProfit(nLoans, interestRate))
}

# So, I can get the desired profit by passing .001 [sometimes] or .002 [better overall]. Here, I leave .002
profit002 <- profitMonteCarlo(1000,.002)
mean(profit002)

```
Losses occur very infrequently with this model, where only 2% of loans default. This model will return a profit with a very low rate of interest. Although the values returned from the profitMonteCarlo simulation are random, I can consistently see a profit of somewhere near $100,000 by charging interest rates around .002 or 0.2%

## Problem 2D

In problem 2C, you were able to set a very low interest rate. Your customers will be very happy and you are expected to earn $100,000 in profits. However, that is just an expectation. Our profit is a random variable. If instead of a profit your bank loses money, your bank defaults. Under the conditions of Problem 2C, what is the probability that your profit is less than 0?

```{r}
##your code here
# The original model proposes c(1, 0), times = c(98,2)/100
#  prob of 0 'bad' = p(.02), prob of 1 'good' = p(.98)

# Here, I am trying to get the z-index for probability that profit will be < 0.
N <- 10000 # number of tries/draws
i <- .001 # lower interest rate increases chance of profit loss
X <- profitMonteCarlo(N,i) # get a sample
SD =  ( 180000*i + 120000) * sqrt(0.02*0.98) # CONFUSION: is SD the same thing as SE???
mu <- (180000 * i) * (1-.98) - (120000 * .02)

mean(X) # mean of sample
sigma <- sd(X) # get sd
z = - sqrt(N) * sum(X) * mu / sigma # This is totally wrong. 



 
# I want to make a Monte Carlo that just returns the sm of good + bad loans. Since bad loans return 0, the sum is actually only the good loans.
getPGoodLoans <- function(nLoans, interestRate=0){
annualProfit <- sample( mortgageOutcome, nLoans, replace=TRUE) 
  x <- sum(annualProfit == 1)# get raw number of good loans
}

baseGoodMonteCarlo <- function(nLoans, interestRate=0, B=10000){
  resultSet <- replicate( B, getPGoodLoans(nLoans, interestRate))
}
goodP <- mean(baseGoodMonteCarlo(N, .002)/N)
pnorm(-1*goodP) + 1-pnorm(goodP)
```

The probability of loss is 0.327

Honestly, I have read the posts for this topic repeatedly, reviewed the lecture notes, and I cannot grasp how I am supposed to get the values, and more importantly, I don't know WHY. 

I know that I need to get an interest rate value that will give me a probability of .001 error.

## Problem 2E

Note that the probability of losing money is quite high. To what value would you have to raise interest rates in order to make the probability of losing money, and your bank and your job, as low as 0.001? What is the expected profit with this interest rate? Corroborate your answer with a Monte Carlo simulation.

Hint: Use the following short cut. If $p$ fraction of a box are $a$s and $(1-p)$ are $b$s, then the SD of the list is $\mid a-b \mid \sqrt{p(1-p)}$ 

Your solution here.

```{r}
###your code here
N <- 10000
profitAt002 <- profitMonteCarlo(N,.002)
mean(profitAt002)/N
#If you sample N times and add the 0s and 1s to create S, the SE is sqrt( N p (1-p) )
SE <- sqrt(N*(0.327*(1-0.327)))

```
The original model assumes that the results are binary: it is either 1 or 0. We also know that the probability of loss is .02. If I apply this formula [$\mid a-b \mid \sqrt{p(1-p)}$] to this situation, the SD [which, because this is a sample == SE] becomes SE <- sqrt(1000*(0.327*(1-0.327))), which in the above case returns 46.91, With a mean of about 113. This is a high rate of error.

## Problem 2F

Note that the Monte Carlo simulation gave a slightly higher probability than 0.001. What is a possible reason for this? 
Hint: See if the disparity is smaller for larger values of $p$. Also check for probabilities larger than 0.001. Recall we made an assumption when we calculated the interest rate.


```{r}
##your code here
N <- 10000
profitAt02BiggerN <- profitMonteCarlo(N,.02)
mean(profitAt02BiggerN)/N
#If you sample N times and add the 0s and 1s to create S, the SE is sqrt( N p (1-p) )
SE <- sqrt(N*(0.317*(1-0.317)))
```


Your answer here.



## Problem 3

We were able to set an interest rate of about 2% that guaranteed a very low probability of having a loss. Furthermore, the expected average was over $1 million. Now other financial companies noticed the success of our business. They also noted that if we increase the number of loans we give, our profits increase. However, the pool of reliable borrowers was limited. So these other companies decided to give loans to less reliable borrowers but at a higher rate.

## Problem 3A

The pool of borrowers they found had a much higher default rate, estimated to be $p=0.05$. What interest rate would give these companies the same expected profit as your bank (Answer to 2E)? 

```{r}
##your code here
```

## Problem 3B 

At the interest rate calculated in 3A what is the probability of negative profits? Use both the normal approximation and then confirm with a Monte Carlo simulation.

```{r}
##your code here
```

## Problem 3C 

Note that the probability is much higher now. This is because the standard deviation grew. The companies giving out the loans did not want to raise interest rates much more since it would drive away clients. Instead they used a statistical approach. They increased $N$. How large does $N$ need to be for this probability to be 0.001? Use the central limit approximation and then confirm with a Monte Carlo simulation.

Your answer here.
```{r}
###your code here
```

So by doubling the number of loans we were able to reduce our risk! Now, for this to work, all the assumptions in our model need to be approximately correct, including the assumption that the probability of default was **independent**. This turned out to be false and the main reason for the under estimation of risk.


## Problem 3D

Define the following matrix of outcomes for two borrowers using our previous box model:

```{r}
loan <- 180000
loss_per_foreclosure <- 120000
p2 <- 0.05
interest_rate2 <- 0.05
B <- 10^5
outcomes1 <- replicate(B,{
  sample( c(-loss_per_foreclosure, interest_rate2*loan ), 2, replace=TRUE, prob=c(p2, 1-p2))
})
```
We can confirm independence by computing the probability of default for the second conditioned on the first defaulting: 

```{r}
sum( outcomes1[1,] < 0 & outcomes1[2,]<0)/sum(outcomes1[1,]<0)
```

This quantity is about the same as the probability of default $0.05$.

Now we create a new model. Before generating each set of defaults, we assume that a random event occurred that makes all default probabilities go up or go down by 4 points. We could see how this would happen if, for example, demand for houses decreases and all house prices drop. 

```{r}
B <- 10^5
outcomes2 <- replicate(B,{
  add <- sample( c(-0.04,0.04), 1)
  sample( c(-loss_per_foreclosure, interest_rate2*loan ), 2, replace=TRUE, prob=c(p2+add, 1-(p2+add)))
})
```

Note that the outcomes are no longer independent as demonstrated by this result not being equal to 0.05

```{r}
sum( outcomes2[1,] < 0 & outcomes2[2,]<0)/sum(outcomes2[1,]<0)
```


Generate a simulation with correlated outcomes such as those above. This time use the interest rate calculated in 3A. What is the expected earnings under this model compared to the previous?

```{r}
###your code here
```


## Problem 4

Read [this wikipedia page](https://en.wikipedia.org/wiki/Financial_crisis_of_2007%E2%80%9308) about the financial crisis. Write a paragraph describing how what you learned in this homework can help explain the conditions that led to the crisis.

Various flawed regulatory, market, technical and human factors converged to cause the Financial Crisis of 2007-2008. A boom in new financial products resulted in more complexity and reduced the ease by which overseers could assess and value risk on the books of financial institutions. The design of many financial products multiplied the number of actors connected to a single mortgage, making accountability and oversight more difficult.
Among the leading factors were a lax regulatory environment that allowed financial institutions to hide their ‘exposure’ or indebtedness, the financial incentive for individual and institutional sellers of mortgages and financial instruments to minimize the risks involved in the investments they offered, and computer models that did not accurately reflect the performance of the market under the rapidly changing conditions introduced by many new and poorly understood types of investments being offered.

The work we did for this assignment has, in a small way, demonstrated some of the methods used to mitigate risk and provide a stronger guarantee of return on investments. We created models that simulated a pseudo ‘historical record’ of a mortgage company that had policies in place that weeded out a very percentage of loan defaulters. Our initial model ((98:02) more closely reflects the kinds of policies that were in place in times preceding those leading up to the Crisis. Under these conditions it was easy to guarantee a profit at a low interest rate, because losses were low. As the losses increase, the rate must also increase to offset those losses. The problem with the models used leading up to the prices is that they did not correctly model all conditions in the dynamic financial environment, aiding many institutions to underestimate risk and over-extend their indebtedness.

